<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageStudy - 회원가입</title>
    <link rel="stylesheet" href="LIB_Style_Mobile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 회원가입 페이지 전체 컨테이너 */
        .join-container {
            max-width: 360px;
            margin: 30px auto;
            padding: 30px 25px 40px;
            background: #fefcf7; /* 깨끗한 크림색 배경 */
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(176, 122, 58, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
            color: #5a4631;
        }

        /* 제목 스타일 */
        .join-container h2 {
            margin-bottom: 25px;
            font-size: 2.25rem;
            font-weight: 700;
            color: #8c6c4b;
            text-align: center;
            letter-spacing: -0.5px;
        }

        /* 라벨 스타일 */
        .join-container label {
            font-weight: 600;
            color: #6f5a3e;
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        /* 입력 필드 스타일 */
        .join-container input[type="text"],
        .join-container input[type="password"],
        .join-container input[type="tel"] {
            width: 90%;
            padding: 12px 14px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            margin-bottom: 18px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .join-container input[type="email"] {
            width: 100%;
            padding: 12px 14px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            margin-bottom: 2px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .join-container input:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        /* 입력 그룹 (필드와 버튼 묶음) */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 18px;
        }

        .input-group input {
            flex: 1;
            margin-bottom: 0;
        }

        .input-group button {
            width: 100px;
            padding: 0 10px;
            font-size: 0.9rem;
            margin: 0;
        }

        /* 이메일 그룹 스타일 */
        .email-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .email-at {
            color: #6f5a3e;
            font-weight: 500;
            margin: 0 4px;
        }

        .email-group input {
            flex: 1;
            min-width: 120px;
        }

        .email-group select {
            width: auto;
            min-width: 120px;
            padding: 12px;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            font-size: 1rem;
            margin-top: 15px;
        }

        .email-group select:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        /* 회원가입 버튼 */
        .join-container button.join-btn {
            width: 100%;
            background-color: #a06934;
            color: #fff9f0;
            border: none;
            border-radius: 14px;
            padding: 14px 0;
            font-weight: 700;
            font-size: 1.15rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(160, 105, 52, 0.6);
            transition: background-color 0.3s ease;
            margin-top: 10px;
            margin-left: 0;
            margin-right: 0;
        }

        .join-container button.join-btn:hover {
            background-color: #8a5a2e;
        }

        /* 중복확인, 인증번호 확인 등 서브 버튼 */
        .join-container button.sub-btn {
            height: 43px;
            background-color: #b07a3a;
            color: #fff9f0;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(176, 122, 58, 0.5);
            transition: background-color 0.3s ease;
        }

        .join-container button.sub-btn:hover {
            background-color: #a06934;
        }

        /* 이미 회원이신가요? 영역 */
        .login-link {
            margin-top: 30px;
            text-align: center;
            font-size: 1rem;
            color: #6f5a3e;
        }

        .login-link a {
            color: #b07a3a;
            text-decoration: none;
            font-weight: 500;
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        .login-link a:hover {
            color: #8c6c4b;
            text-decoration: underline;
        }

        /* 필수 입력 표시 */
        .required-mark, .required-indicator {
            color: #c25e3a;
            margin-left: 4px;
        }

        /* 반응형 */
        @media (max-width: 400px) {
            .join-container {
                margin: 20px 10px;
                padding: 25px 20px 30px;
                box-shadow: none;
            }
            .join-container h2 {
                font-size: 2rem;
            }
            .input-group {
                flex-direction: column;
                gap: 5px;
            }
            .input-group button {
                width: 100%;
                padding: 10px;
            }
            .email-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .email-group input,
            .email-group select {
                width: 100%;
            }
        }
    </style>
</head>
<body onload="loadHeaderFooter()">
    <div id="app">
        <div id="header-container"></div>
        <div id="main-content">
            <div class="join-container">
                <h2>회원가입</h2>
                <label for="userId_input">아이디 <span class="required-mark">*</span></label>
                <div class="input-group">
                    <input type="text" v-model="userId" id="userId_input" :disabled="isUserIdDisabled" required placeholder="아이디 입력">
                    <button class="sub-btn" @click="fnCheckId">중복확인</button>
                </div>

                <label for="userPwd_input">비밀번호 <span class="required-mark">*</span></label>
                <input type="password" v-model="userPwd" id="userPwd_input" required placeholder="영어 소문자 + 숫자 포함 6자리 이상">

                <label for="userPwdConfirm_input">비밀번호 확인 <span class="required-mark">*</span></label>
                <input type="password" v-model="userPwdConfirm" id="userPwdConfirm_input" required placeholder="비밀번호 재입력">

                <label for="userName_input">이름 <span class="required-mark">*</span></label>
                <input type="text" id="userName_input" v-model="userName" placeholder="이름 입력">



                <label for="emailId_input">E-MAIL(이메일) <span class="required-mark">*</span></label>
                <div class="input-group email-group">
                    <input type="email" id="emailId_input" v-model="emailId" placeholder="이메일 아이디 입력">
                    <span class="email-at">@</span>
                    <input type="email" v-model="emailDomain" :disabled="selectedDomain !== 'direct'">
                    <select v-model="selectedDomain" @change="handleDomainChange">
                        <option value="direct">직접 입력</option>
                        <option value="naver.com">naver.com</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="daum.net">daum.net</option>
                    </select>
                </div>

                <label for="phoneInput">핸드폰 번호 <span class="required-mark">*</span></label>
                <input type="text" v-model="phone" id="phoneInput" required placeholder="(-) 하이픈 제외 숫자만 입력">


                <label for="address">주소</label>
                <div class="input-group">
                    <input type="text" id="address">
                    <button class="sub-btn" @click="fnAddr">주소 검색</button>
                </div>

                <button class="join-btn" @click="fnRegister">회원가입</button>
            </div>
        </div>
        <div id="footer-container"></div>
    </div>
</body>
</html>

<script>
    // 헤더와 푸터를 동적으로 불러오는 함수
    function loadHeaderFooter() {
        // 헤더 로드
        fetch('LIB_Header.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Header.html에서 <header> 태그 부분만 추출하여 삽입
                const headerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('header');
                document.getElementById('header-container').appendChild(headerContent);
            });
        
        // 푸터 로드
        fetch('LIB_Footer.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Footer.html에서 <footer> 태그 부분만 추출하여 삽입
                const footerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('footer');
                document.getElementById('footer-container').appendChild(footerContent);
            });
    }
    function jusoCallBack(roadFullAddr, roadAddrPart1, addrDetail, roadAddrPart2, engAddr, jibunAddr, zipNo, admCd, rnMgtSn, bdMgtSn, detBdNmList, bdNm, bdKdcd, siNm, sggNm, emdNm, liNm, rn, udrtYn, buldMnnm, buldSlno, mtYn, lnbrMnnm, lnbrSlno, emdNo) {
        console.log("roadFullAddr =>", roadFullAddr);
        console.log("roadAddrPart1 =>", roadAddrPart1);
        console.log("addrDetail =>", addrDetail);
        console.log("roadAddrPart2 =>", roadAddrPart2);
        console.log("engAddr =>", engAddr);
        console.log("jibunAddr =>", jibunAddr);
        console.log("zipNo =>", zipNo);
        console.log("admCd =>", admCd);
        console.log("rnMgtSn =>", rnMgtSn);
        console.log("bdMgtSn =>", bdMgtSn);
        console.log("detBdNmList =>", detBdNmList);
        console.log("bdNm =>", bdNm);
        console.log("bdKdcd =>", bdKdcd);
        console.log("siNm =>", siNm);
        console.log("sggNm =>", sggNm);
        console.log("emdNm =>", emdNm);
        console.log("liNm =>", liNm);
        console.log("rn =>", rn);
        console.log("udrtYn =>", udrtYn);
        console.log("buldMnnm =>", buldMnnm);
        console.log("buldSlno =>", buldSlno);
        console.log("mtYn =>", mtYn);
        console.log("lnbrMnnm =>", lnbrMnnm);
        console.log("lnbrSlno =>", lnbrSlno);
        console.log("emdNo =>", emdNo);
        // window.vueObj.fnResult(roadFullAddr, roadAddrPart1, addrDetail, engAddr);
        // 전체 주소를 Vue 인스턴스의 address 변수에 할당
        window.app._instance.data.address = roadFullAddr;
    }
    const app = Vue.createApp({
        data() {
            return {
                // 변수 - (key : value)
                userId : "",         // 아이디 추가
                userPwd : "",        // 비밀번호 추가
                userPwdConfirm : "", // 비밀번호 확인 추가
                userName : "",       // 이름 추가
                emailId : "",        // 이메일 아이디
                emailDomain : "",    // 이메일 도메인
                selectedDomain : "direct",  // 선택된 도메인
                phone : "",          // 핸드폰 번호 추가
                address : "",        // 주소 추가
                isUserIdDisabled : false, // 아이디 입력란 비활성화 여부 (초기값: 활성화)
                isIdDuplicationChecked : false // 아이디 중복확인 완료 여부 (초기값: false)
            };
        },
        methods: {
            // 함수(메소드) - (key : function())

            // 이메일 도메인 선택 처리 메소드
            handleDomainChange: function() {
                let self = this;
                
                if(self.selectedDomain === 'direct') {
                    // '직접 입력' 선택 시 도메인 입력란 활성화
                    self.emailDomain = '';
                    // Vue에서는 disabled 속성을 데이터로 관리 가능
                } else {
                    // 특정 도메인 선택 시 해당 값 자동 입력
                    self.emailDomain = self.selectedDomain;
                }
            },
            // 전화번호 형식 변환 함수
            // rawPhoneNumber: 하이픈 제외된 숫자만 있는 문자열
            formatPhoneNumber: function(rawPhoneNumber) {
                if (!rawPhoneNumber) return ""; // 입력값이 없으면 빈 문자열 반환

                // 숫자 외의 모든 문자 제거
                const cleaned = rawPhoneNumber.replace(/[^0-9]/g, '');
                let result = cleaned; // 기본값은 숫자만 있는 상태

                // 한국 휴대폰 번호 (010으로 시작하고 11자리) 형식에 맞춰 변환
                // 예: 01012345678 -> 010-1234-5678
                if (cleaned.length === 11 && cleaned.startsWith('010')) {
                    result = cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } 
                // 10자리 번호 (02-xxxx-xxxx 또는 0XX-xxx-xxxx)
                else if (cleaned.length === 10) {
                    if (cleaned.startsWith('02')) { // 서울 번호 (02-xxxx-xxxx)
                        result = cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
                    } else { // 일반 지역번호 (0XX-xxx-xxxx)
                        result = cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                    }
                }

                return result;
            },
            // 아이디 중복 확인 메소드
            fnCheckId: function() {
                let self = this;
                let param = {userId: self.userId.trim()};
                
                // 아이디 입력 여부 확인
                if(!self.userId || self.userId.trim() === "") {
                    alert("아이디를 입력해주세요");
                    return;
                }
                
                // 서버에 중복 확인 요청
                $.ajax({
                    url: "http://localhost:3009/lib/checkId",
                    dataType: "json",
                    type: "GET",
                    data: param,
                    success: function(data) {
                        if(data.duplicate) {
                            alert("이미 사용 중인 아이디입니다. 다른 아이디를 입력해주세요.");
                            self.isIdDuplicationChecked = false; // 중복이면 체크 안 된 상태
                            self.isUserIdDisabled = false; // 아이디 입력 필드 다시 활성화 (새 아이디 입력 유도)
                            document.getElementById("userId_input").focus();
                            // 다시 아이디 입력 필드로 포커스
                        } else {
                            alert("사용 가능한 아이디입니다.");
                            self.isIdDuplicationChecked = true; // 아이디 사용 가능 -> 체크 완료!
                            self.isUserIdDisabled = true; // 아이디 입력 부분 비활성화

                            // 비밀번호 입력란에 포커스
                            // HTML에 비밀번호 input의 id가 "userPwd_input"이므로 해당 ID를 사용합니다.
                            document.getElementById("userPwd_input").focus();
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("중복 확인 중 오류가 발생했습니다. 다시 시도해주세요.");
                        self.isIdDuplicationChecked = false; // 오류 발생 시 체크 안 된 상태
                        console.error(error);
                    }
                });
            },
            fnRegister: function() {
                let self = this;

                // 아이디 중복확인 여부 검사
                if (!self.isIdDuplicationChecked) {
                    alert("아이디 중복확인을 먼저 해주세요.");
                    document.getElementById("userId_input").focus(); // 아이디 입력란으로 포커스
                    return;
                }

                // 필수 입력값 검증
                if(!self.userId || self.userId.trim() === "") {
                    alert("아이디를 입력해주세요");
                    self.isIdDuplicationChecked = false; // 아이디 비어있으면 체크 초기화
                    document.getElementById('userId_input').focus();
                    return;
                }
                if(!self.userPwd || self.userPwd.trim() === "") {
                    alert("비밀번호를 입력해주세요");
                    return;
                }
                // 비밀번호 정규식 검사
                // const는 상수를 선언할 때 사용
                // 한 번 할당하면 재할당이 불가능
                // 선언과 동시에 초기화
                //  값이 변경되지 않아야 하는 경우에 사용 권장
                const pwdRule = /^(?=.*[a-z])(?=.*\d)[a-z\d]{6,}$/;
                if(!pwdRule.test(self.userPwd)) {
                    alert("비밀번호는 영어 소문자와 숫자를 포함하여 6자리 이상이어야 합니다");
                    document.getElementById("userPwd_input").focus();
                    return;
                }
                if(self.userPwd !== self.userPwdConfirm) {
                    alert("비밀번호가 일치하지 않습니다");
                    return;
                }
                if(!self.userName || self.userName.trim() === "") {
                    alert("이름을 입력해주세요");
                    return;
                }
                if(!self.emailId || self.emailId.trim() === "") {
                    alert("이메일 아이디를 입력해주세요");
                    return;
                }
                if(!self.emailDomain || self.emailDomain.trim() === "") {
                    alert("이메일 도메인을 선택하거나 입력해주세요");
                    return;
                }
                // 이메일 조합
                let email = self.emailId.trim() + "@" + self.emailDomain.trim();

                // 이메일 형식 유효성 검사
                const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                if(!emailRegex.test(email)) {
                    alert("올바른 이메일 형식이 아닙니다");
                    return;
                }
                // 핸드폰 번호 입력 확인
                if(!self.phone || self.phone.trim() === "") {
                    alert("핸드폰 번호를 입력해주세요");
                    document.getElementById("phoneInput").focus();
                    return;
                }
                // 핸드폰 번호 형식 확인 (숫자만 입력했는지)
                const phoneDigitsOnlyRegex = /^[0-9]+$/;
                if(!phoneDigitsOnlyRegex.test(self.phone.trim())) {
                    alert("핸드폰 번호는 숫자만 입력해주세요");
                    document.getElementById("phoneInput").focus();
                    return;
                }

                // 서버로 전송할 데이터
                let param = {
                    userId: self.userId.trim(),
                    password: self.userPwd.trim(),
                    name: self.userName.trim(),
                    email: email,
                    phone: self.formatPhoneNumber(self.phone),
                    // trim() 불필요한 이유 : 위의 이메일 조합과 핸드폰번호 형식 확인의
                    // self.formatPhoneNumber(self.phone) 함수 내부에서
                    // 이미 불필요한 공백을 포함한 숫자 외의 모든 문자를 제거하고 있음
                    address: self.address
                };

                // 서버에 회원가입 요청
                $.ajax({
                    url: "http://localhost:3009/lib/join",
                    dataType: "json",
                    type: "GET",  // POST 방식으로 데이터 전송
                    data: param,
                    success: function(data) {
                        if(data.success) {
                            // 회원가입 성공
                            alert("회원가입이 완료되었습니다. 로그인 페이지로 이동합니다.");
                            // 로그인 페이지로 이동 (필요시 수정)
                            location.href = "LIB_Login.html";
                        } else {
                            // 회원가입 실패
                            alert(data.message || "회원가입에 실패했습니다. 다시 시도해주세요.");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("오류가 발생했습니다. 다시 시도해주세요.");
                        console.error(error);
                    }
                });
            },
            fnAddr: function() {
                // window.open("LIB_JusoPopup.html", "addr", "width=500, height=500");
                alert("주소 검색 및 입력은 준비중입니다.");
            },
            
        }, // methods
        mounted() {
            // 처음 시작할 때 실행되는 부분
            let self = this;
        }
    });

    app.mount('#app');
</script>