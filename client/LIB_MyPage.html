<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageStudy - 회원정보 수정</title>
    <link rel="stylesheet" href="LIB_Style_Mobile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 회원정보 수정 페이지 컨테이너 스타일 */
        .mypage-container {
            max-width: 480px;
            margin: 30px auto;
            padding: 30px 25px 40px;
            background: #fefcf7; /* 깨끗한 크림색 배경 */
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(176, 122, 58, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
            color: #5a4631;
        }

        /* 제목 스타일 */
        .mypage-container h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #8c6c4b;
            text-align: center;
            margin-bottom: 30px;
            letter-spacing: -0.5px;
        }

        /* 입력 필드 그룹 스타일 */
        .mypage-container .form-group {
            margin-bottom: 20px;
        }

        /* 라벨 스타일 */
        .mypage-container label {
            display: block;
            font-weight: 600;
            color: #6f5a3e;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        /* 인풋 필드 스타일 */
        .mypage-container input[type="text"],
        .mypage-container input[type="password"] {
            width: 90%;
            padding: 12px 14px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .mypage-container input[type="text"]:focus,
        .mypage-container input[type="password"]:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        /* 비활성화된 입력 필드 */
        .mypage-container input:disabled {
            background-color: #f0e9e0;
            color: #8c7b64;
            cursor: not-allowed;
        }

        /* 이메일 입력 그룹 */
        .mypage-container .email-input-wrapper {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        .mypage-container .email-input-wrapper input:first-child {
            flex: 1 1 40%;
        }

        .mypage-container .email-at {
            color: #6f5a3e;
            font-weight: 500;
            margin: 0 4px;
        }

        .mypage-container .email-input-wrapper input:nth-child(3) {
            flex: 1 1 30%;
        }

        .mypage-container .email-input-wrapper select {
            flex: 1 1 20%;
            padding: 12px 8px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            transition: border-color 0.3s ease;
        }

        .mypage-container .email-input-wrapper select:focus {
            border-color: #b07a3a;
            outline: none;
        }

        /* 주소 입력 그룹 */
        .mypage-container .address-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .mypage-container .address-input-wrapper input {
            flex: 1;
        }
        .address-input-wrapper input {
            height: 25px;
        }
        .mypage-container .address-input-wrapper button.sub-btn {
            width: auto;
            min-width: 100px;
            height: 50px;
            padding: 0 15px;
            background-color: #b07a3a;
            color: #fff9f0;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(176, 122, 58, 0.5);
            transition: background-color 0.3s ease;
        }
        .address-input-wrapper button.sub-btn {
            margin-top: 2px;
        }

        .mypage-container .address-input-wrapper button.sub-btn:hover {
            background-color: #a06934;
        }

        /* 필수 입력 표시 */
        .mypage-container .required-mark {
            color: #c25e3a; /* 약간 붉은 오렌지 */
            margin-left: 4px;
        }

        /* 비밀번호 변경 섹션 */
        .mypage-container .password-section {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1.5px solid #e6d9c4;
        }

        .mypage-container .password-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #8c6c4b;
            margin-bottom: 20px;
        }

        /* 버튼 그룹 */
        .mypage-container .button-group {
            display: flex;
            gap: 12px;
            margin-top: 35px;
        }

        .mypage-container .button-group button {
            flex: 1;
            padding: 14px 0;
            font-weight: 700;
            font-size: 1.05rem;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .mypage-container .save-btn {
            background-color: #a06934;
            color: #fff9f0;
            box-shadow: 0 5px 15px rgba(160, 105, 52, 0.6);
        }

        .mypage-container .save-btn:hover {
            background-color: #8a5a2e;
        }

        .mypage-container .main-btn {
            background-color: #8c7b64;
            color: #fff9f0;
            box-shadow: 0 5px 15px rgba(140, 123, 100, 0.6);
        }

        .mypage-container .main-btn:hover {
            background-color: #7a6a54;
        }

        .mypage-container .withdraw-btn {
            background-color: #dc3545;
            color: #fff9f0;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.6);
        }

        .mypage-container .withdraw-btn:hover {
            background-color: #c82333;
        }

        /* 안내 문구 */
        .mypage-container .notice-text {
            margin-top: 20px;
            color: #8c7b64;
            font-size: 0.9rem;
            text-align: center;
        }

        /* 반응형 */
        @media (max-width: 500px) {
            .mypage-container {
                margin: 20px 15px;
                padding: 25px 20px 30px;
                box-shadow: none;
            }
            
            .mypage-container h2 {
                font-size: 2rem;
            }
            
            .mypage-container .button-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .mypage-container .email-input-wrapper {
                flex-direction: column;
                align-items: stretch;
            }
            
            .mypage-container .email-at {
                align-self: flex-start;
                margin: 8px 0;
            }
            
            .mypage-container .address-input-wrapper {
                flex-direction: column;
            }
            
            .mypage-container .address-input-wrapper button.sub-btn {
                width: 100%;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body onload="loadHeaderFooter()">
    <main id="app">
        <div id="header-container"></div>

        <div id="main-content">
            <div class="mypage-container">
                <h2>회원정보 수정</h2>

                <div>
                    <label for="userId_input">아이디</label>
                    <input type="text" id="userId_input" v-model="userId" disabled>
                </div>
                
                <div>
                    <label for="userName_input">이름 <span class="required-mark">*</span></label>
                    <input type="text" id="userName_input" v-model="userName">
                </div>

                <div class="form-group email-group">
                    <label for="emailId">E-MAIL(이메일) <span class="required-mark">*</span></label>
                    <div class="email-input-wrapper">
                        <input type="text" id="emailId" v-model="emailId">
                        <span class="email-at">@</span>
                        <input type="text" v-model="emailDomain" :disabled="selectedDomain !== 'direct'">
                        <select v-model="selectedDomain" @change="handleDomainChange">
                            <option value="direct">직접 입력</option>
                            <option value="naver.com">naver.com</option>
                            <option value="gmail.com">gmail.com</option>
                            <option value="daum.net">daum.net</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="phone_input">핸드폰 번호 <span class="required-mark">*</span></label>
                    <input type="text" id="phone_input" v-model="phone" placeholder="(-) 하이픈 제외 숫자만 입력">
                </div>

                <div class="form-group address-group">
                    <label for="address_input">주소</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="address_input" v-model="address" placeholder="주소를 검색해주세요." readonly>
                        <button type="button" class="sub-btn" @click="fnAddr">주소 검색</button>
                    </div>
                </div>

                <div class="password-section">
                    <h3>비밀번호 변경</h3>
                    <div class="form-group">
                        <label for="current_pwd">기존 비밀번호 <span class="required-mark">*</span></label>
                        <input type="password" id="current_pwd" v-model="currentPassword" placeholder="현재 비밀번호를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label for="new_pwd">새 비밀번호 <span class="required-mark">*</span></label>
                        <input type="password" id="new_pwd" v-model="newPassword" placeholder="영어 소문자/숫자 포함 6자리 이상">
                    </div>
                    <div class="form-group">
                        <label for="confirm_pwd">새 비밀번호 확인 <span class="required-mark">*</span></label>
                        <input type="password" id="confirm_pwd" v-model="confirmNewPassword" placeholder="새 비밀번호를 다시 입력하세요">
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="save-btn" @click="fnUpdateUser">정보 저장</button>
                    <button type="button" class="main-btn" @click="goToMain">메인으로</button>
                    <button type="button" class="withdraw-btn" @click="fnWithdraw">회원 탈퇴</button>
                </div>
                <p class="notice-text">* 기존 비밀번호를 입력해야 회원 정보 및 비밀번호 변경이 가능합니다.</p>
            </div>
        </div>
        <div id="footer-container"></div>
    </main>
</body>
</html>

<script>
    // 헤더와 푸터를 동적으로 불러오는 함수
    function loadHeaderFooter() {
        // 헤더 로드
        fetch('LIB_Header.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Header.html에서 <header> 태그 부분만 추출하여 삽입
                const headerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('header');
                document.getElementById('header-container').appendChild(headerContent);
            });
        
        // 푸터 로드
        fetch('LIB_Footer.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Footer.html에서 <footer> 태그 부분만 추출하여 삽입
                const footerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('footer');
                document.getElementById('footer-container').appendChild(footerContent);
            });
    }

    // jusoCallBack 함수는 전역 함수로 LIB_JusoPopup.html에서 호출됨
    // 이 함수가 Vue 앱 인스턴스의 address 데이터를 업데이트하도록 수정 필요
    function jusoCallBack(roadFullAddr, roadAddrPart1, addrDetail, roadAddrPart2, engAddr, jibunAddr, zipNo, admCd, rnMgtSn, bdMgtSn, detBdNmList, bdNm, bdKdcd, siNm, sggNm, emdNm, liNm, rn, udrtYn, buldMnnm, buldSlno, mtYn, lnbrMnnm, lnbrSlno, emdNo) {
        // Vue 앱 인스턴스에 접근하여 데이터 업데이트
        // app._instance.data 또는 app.config.globalProperties 등을 통해 접근 가능 (Vue 3 방식)
        // 더 안전하게는 이벤트를 발행하여 Vue 인스턴스가 받도록 하는 것이 좋음
        if (window.vueMyPageApp) { // window.vueMyPageApp은 Vue 인스턴스가 마운트된 후 할당될 전역 변수
            window.vueMyPageApp.address = roadFullAddr;
        }
    }

    const app = Vue.createApp({
        data() {
            return {
                userId: "",
                userName: "",
                userPwd: "",
                emailId: "",
                emailDomain: "",
                selectedDomain: "direct",
                phone: "",
                address: "",
                currentPassword: "", // 기존 비밀번호
                newPassword: "",     // 새 비밀번호
                confirmNewPassword: "" // 새 비밀번호 확인
            };
        },
        methods: {
            // 이메일 도메인 선택 처리 (LIB_Join.html과 동일)
            handleDomainChange: function() {
                let self = this;
                if(self.selectedDomain === 'direct') {
                    self.emailDomain = '';
                } else {
                    self.emailDomain = self.selectedDomain;
                }
            },
            // 전화번호 형식 변환 함수 (LIB_Join.html과 동일)
            formatPhoneNumber: function(rawPhoneNumber) {
                if (!rawPhoneNumber) return "";
                const cleaned = rawPhoneNumber.replace(/[^0-9]/g, '');
                let result = cleaned;
                if (cleaned.length === 11 && cleaned.startsWith('010')) {
                    result = cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } else if (cleaned.length === 10) {
                    if (cleaned.startsWith('02')) {
                        result = cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
                    } else {
                        result = cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                    }
                }
                return result;
            },
            // 주소 검색 팝업 (LIB_Join.html과 동일)
            fnAddr: function() {
                // window.open("LIB_JusoPopup.html", "addr", "width=500, height=500");
                alert("주소 검색 및 입력은 준비중입니다.");
            },
            // 현재 사용자 정보 불러오기
            loadUserInfo: function() {
                let self = this;
                const loggedInUserId = sessionStorage.getItem("sessionId");

                if (!loggedInUserId) {
                    alert("로그인이 필요합니다.");
                    location.href = "LIB_Login.html";
                    return;
                }
                self.userId = loggedInUserId;

                $.ajax({
                    url: "http://localhost:3009/lib/userInfo",
                    dataType: "json",
                    type: "GET",
                    data: { userId: loggedInUserId },
                    success: function(data) {
                        if(data) { // data가 있을 때만 처리 (null 또는 undefined 체크)
                            self.userName = data.NAME;
                            self.phone = data.PHONE ? data.PHONE.replace(/-/g, '') : '';
                            self.address = data.ADDRESS;

                            // 이메일 분리하여 바인딩
                            if (data.EMAIL) {
                                const emailParts = data.EMAIL.split('@');
                                self.emailId = emailParts[0] || '';
                                self.emailDomain = emailParts[1] || '';
                                
                                // 도메인 선택값 설정
                                if (self.emailDomain === 'naver.com' || self.emailDomain === 'gmail.com' || self.emailDomain === 'daum.net') {
                                    self.selectedDomain = self.emailDomain;
                                } else {
                                    self.selectedDomain = 'direct';
                                }
                            }
                        } else {
                            alert("사용자 정보를 불러오는데 실패했습니다.");
                            location.href = "LIB_Main.html";
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("사용자 정보를 불러오는 중 오류가 발생했습니다.");
                        console.error(error);
                        location.href = "LIB_Main.html";
                    }
                });
            },
            // 사용자 정보 업데이트
            fnUpdateUser: function() {
                let self = this;
                const pwdRule = /^(?=.*[a-z])(?=.*\d)[a-z\d]{6,}$/;

                // 유효성 검사 (LIB_Join.html과 유사)
                if(!self.userName || self.userName.trim() === "") {
                    alert("이름을 입력해주세요");
                    return;
                }
                if(!self.emailId || self.emailId.trim() === "") {
                    alert("이메일 아이디를 입력해주세요");
                    return;
                }
                if(!self.emailDomain || self.emailDomain.trim() === "") {
                    alert("이메일 도메인을 선택하거나 입력해주세요");
                    return;
                }
                let email = self.emailId.trim() + "@" + self.emailDomain.trim();
                const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                if(!emailRegex.test(email)) {
                    alert("올바른 이메일 형식이 아닙니다");
                    return;
                }
                if(!self.phone || self.phone.trim() === "") {
                    alert("핸드폰 번호를 입력해주세요");
                    return;
                }
                const phoneDigitsOnlyRegex = /^[0-9]+$/;
                if(!phoneDigitsOnlyRegex.test(self.phone.trim())) {
                    alert("핸드폰 번호는 숫자만 입력해주세요");
                    return;
                }

                // 기존 비밀번호 입력 확인
                if (!self.currentPassword || self.currentPassword.trim() === "") {
                    alert("회원 정보를 수정하려면 기존 비밀번호를 입력해야 합니다.");
                    return;
                }

                // 새 비밀번호가 입력되었다면 유효성 검사
                if (self.newPassword.trim() !== "") {
                    if (!pwdRule.test(self.newPassword)) {
                        alert("새 비밀번호는 영어 소문자와 숫자를 포함하여 6자리 이상이어야 합니다");
                        return;
                    }
                    if (self.newPassword !== self.confirmNewPassword) {
                        alert("새 비밀번호가 일치하지 않습니다");
                        return;
                    }
                }

                // 서버로 전송할 데이터
                let param = {
                    userId: self.userId, // USERID는 수정 불가
                    name: self.userName.trim(),
                    email: email,
                    phone: self.phone.replace(/-/g, ''), // DB 저장을 위해 하이픈 제거
                    address: self.address,
                    currentPassword: self.currentPassword.trim(), // 기존 비밀번호 전송
                    newPassword: self.newPassword.trim() // 새 비밀번호 전송 (입력되지 않았다면 빈 문자열)
                };

                $.ajax({
                    url: "http://localhost:3009/lib/updateUserInfo",
                    dataType: "json",
                    type: "GET", // 학원 지침에 따라 GET 사용 (UPDATE는 POST가 일반적)
                    data: param,
                    success: function(data) {
                        if(data.success) {
                            alert(data.message); // 서버에서 전달받은 메시지 사용
                            self.loadUserInfo(); // 수정된 정보 다시 불러와 반영
                            self.currentPassword = ""; // 비밀번호 필드 초기화
                            self.newPassword = "";
                            self.confirmNewPassword = "";
                        } else {
                            alert(data.message || "회원 정보 수정에 실패했습니다.");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("회원 정보 수정 중 오류가 발생했습니다.");
                        console.error(error);
                    }
                });
            },
            goToMain: function() {
                location.href = "LIB_Main.html"; // 메인 페이지로 이동
            },
            fnWithdraw: function() {
                let self = this;
                
                // 탈퇴 확인 메시지
                if (!confirm("정말 탈퇴하시겠습니까? 모든 회원 정보가 삭제됩니다.")) {
                    return; // 취소 시 함수 종료
                }
                
                // 비밀번호 확인
                if (!self.currentPassword || self.currentPassword.trim() === "") {
                    alert("회원 탈퇴를 위해서는 현재 비밀번호를 입력해야 합니다.");
                    return;
                }
                
                // 서버에 탈퇴 요청 전송
                $.ajax({
                    url: "http://localhost:3009/lib/withdraw",
                    dataType: "json",
                    type: "GET", // 학원 지침에 따라 GET 사용 (보안상 POST 권장)
                    data: {
                        userId: self.userId,
                        password: self.currentPassword.trim()
                    },
                    success: function(data) {
                        if(data.success) {
                            alert("회원 탈퇴가 완료되었습니다. 그동안 이용해 주셔서 감사합니다.");
                            
                            // 세션 삭제
                            sessionStorage.removeItem("sessionId");
                            sessionStorage.removeItem("sessionName");
                            
                            // 메인 페이지로 리다이렉트
                            location.href = "LIB_Main.html";
                        } else {
                            alert(data.message || "회원 탈퇴에 실패했습니다.");
                        }
                    },
                    error: function(xhr, status, error) {
                        alert("회원 탈퇴 중 오류가 발생했습니다.");
                        console.error(error);
                    }
                });
            }
        },
        mounted() {
            // Vue 인스턴스가 마운트될 때 전역 변수에 할당 (jusoCallBack에서 접근 위함)
            window.vueMyPageApp = this; 
            this.loadUserInfo(); // 페이지 로드 시 사용자 정보 불러오기
        }
    });

    app.mount('#app');
</script>
