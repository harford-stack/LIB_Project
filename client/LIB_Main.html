<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageStudy - 메인</title>
    <link rel="stylesheet" href="LIB_Style_Mobile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="js/common.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <style>
        .main-container {
            max-width: 360px; /* 모바일 고정 폭 내에서 로그인 박스의 최대 너비 */
            margin: 30px auto; /* #main-content 내부에서의 상하 마진 및 좌우 자동 중앙 정렬 */
            padding: 30px 25px 40px;
            background: #fefcf7;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(176, 122, 58, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
            color: #5a4631;
        }
    </style>
</head>
<body onload="loadHeaderFooter()">
    <!-- Vue 앱 전체를 <main> 태그로 감싸고, id="app"은 유지 -->
    <main id="app">
        <div id="header-container"></div>
        <div id="main-content">
            <div class="main-container">
                <!-- 로그인 상태에 따라 다른 메시지 표시 -->
                <h3 v-if="sessionId">안녕하세요, {{ userName }}님!</h3>
                <h3 v-else>안녕하세요,<br>PageStudy 스터디카페입니다.</h3>

                <!-- 로그인 여부에 따라 버튼 다르게 표시 -->
                <template v-if="sessionId">
                    <!-- 클래스 이름 변경: primary -> btn-primary, secondary -> btn-back-to-main (컨셉에 따라) -->
                    <button class="btn-primary" @click="goToMyReservations">내 예약 확인</button>
                    <button class="btn-primary" @click="goToMyPage">회원정보 수정</button>
                    <button class="btn-back-to-main" @click="logout">로그아웃</button>
                </template>
                <template v-else>
                    <button class="btn-primary" @click="goToLoginPage">로그인</button>
                    <button class="btn-back-to-main" @click="goToJoinPage">회원가입</button>
                </template>
                <!-- 좌석 예약 버튼도 btn-primary로 -->
                <button class="btn-primary" @click="goToSeatBooking">좌석 예약</button>
                <button class="btn-primary" @click="goToUseInfo">이용 안내 및 요금</button>
                <button class="btn-primary" @click="goToLocation">오시는 길</button>
            </div>
        </div>
        <div id="footer-container"></div>
    </main>
</body>
</html>

<script>
    const app = Vue.createApp({
        data() {
            return {
                userName: "",
                sessionId: ""
            };
        },
        methods: {
            logout: function() {
                logout();
            },
            goToMyPage: function() {
                location.href = "LIB_MyPage.html";
            },
            goToSeatBooking: function() {
                location.href = "LIB_Reservation.html";
            },
            goToLoginPage: function() {
                location.href = "LIB_Login.html";
            },
            goToJoinPage: function() {
                location.href = "LIB_Join.html";
            },
            goToMyReservations: function() {
                location.href = "LIB_MyReservations.html";
            },
            goToUseInfo: function() {
                location.href = "LIB_UseInfo.html";
            },
            goToLocation() {
                location.href = "LIB_Location.html";
            }
        },
        mounted() {
            let self = this;
            // JWT 토큰 기반 인증 확인
            if (window.getAuth) {
                const auth = window.getAuth();
                if (auth && auth.user) {
                    self.sessionId = auth.user.USERID;
                    self.userName = auth.user.NAME;
                }
            } else {
                // 기존 방식 호환성
                self.sessionId = sessionStorage.getItem("sessionId");
                self.userName = sessionStorage.getItem("sessionName");
            }
            
            // URL 파라미터에서 토큰 확인 (소셜 로그인 후 리다이렉트)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const userStr = urlParams.get('user');
            const error = urlParams.get('error');
            
            // 에러 처리
            if (error) {
                alert('로그인 실패: ' + decodeURIComponent(error));
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // 토큰 및 사용자 정보 처리 (이미 처리된 경우 스킵)
            if (token && userStr) {
                // 이미 인증 정보가 저장되어 있는지 확인
                const existingAuth = window.getAuth ? window.getAuth() : null;
                const existingToken = window.getToken ? window.getToken() : null;
                
                // 같은 토큰이면 이미 처리된 것으로 간주
                if (existingToken === token) {
                    console.log('이미 처리된 소셜 로그인입니다. 스킵합니다.');
                    // URL에서 파라미터만 제거
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                try {
                    const user = JSON.parse(decodeURIComponent(userStr));
                    console.log('소셜 로그인 성공:', user);
                    
                    if (window.saveAuth) {
                        window.saveAuth(token, user);
                        console.log('인증 정보 저장 완료');
                    } else {
                        console.error('saveAuth 함수가 없습니다. auth.js가 로드되었는지 확인하세요.');
                    }
                    
                    self.sessionId = user.USERID;
                    self.userName = user.NAME;
                    
                    // URL에서 파라미터 제거
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // 성공 메시지 (한 번만 표시)
                    alert(`${user.NAME}님 환영합니다!`);
                } catch (e) {
                    console.error('소셜 로그인 처리 오류:', e);
                    alert('로그인 처리 중 오류가 발생했습니다.');
                }
            }
        }
    });

    app.mount('#app');
</script>