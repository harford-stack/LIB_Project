<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageStudy - 회원가입</title>
    <link rel="stylesheet" href="LIB_Style_Mobile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* 회원가입 페이지 전체 컨테이너 */
        .join-container {
            max-width: 360px;
            margin: 30px auto;
            padding: 30px 25px 40px;
            background: #fefcf7; /* 깨끗한 크림색 배경 */
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(176, 122, 58, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
            color: #5a4631;
        }

        /* 제목 스타일 */
        .join-container h2 {
            margin-bottom: 25px;
            font-size: 2.25rem;
            font-weight: 700;
            color: #8c6c4b;
            text-align: center;
            letter-spacing: -0.5px;
        }

        /* 라벨 스타일 */
        .join-container label {
            font-weight: 600;
            color: #6f5a3e;
            display: block;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        /* 입력 필드 스타일 */
        .join-container input[type="text"],
        .join-container input[type="password"],
        .join-container input[type="tel"] {
            width: 90%;
            padding: 12px 14px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            margin-bottom: 15px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .join-container input[type="email"] {
            width: 100%;
            padding: 12px 14px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            margin-bottom: 2px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .join-container input:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        /* 입력 그룹 (필드와 버튼 묶음) */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 18px;
        }

        .input-group input {
            flex: 1;
            margin-bottom: 0;
        }

        .input-group button {
            width: 100px;
            padding: 0 10px;
            font-size: 0.9rem;
            margin: 0;
        }

        /* 이메일 그룹 스타일 */
        .email-group {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .email-at {
            color: #6f5a3e;
            font-weight: 500;
            margin: 0 4px;
        }

        .email-group input {
            flex: 1;
            min-width: 120px;
        }

        .email-group select {
            width: auto;
            min-width: 120px;
            padding: 12px;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            font-size: 1rem;
            margin-top: 15px;
        }

        .email-group select:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        /* 회원가입 버튼 */
        .join-container button.join-btn {
            width: 100%;
            background-color: #a06934;
            color: #fff9f0;
            border: none;
            border-radius: 14px;
            padding: 14px 0;
            font-weight: 700;
            font-size: 1.15rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(160, 105, 52, 0.6);
            transition: background-color 0.3s ease;
            margin-top: 10px;
            margin-left: 0;
            margin-right: 0;
        }

        .join-container button.join-btn:hover {
            background-color: #8a5a2e;
        }

        /* 중복확인, 인증번호 확인 등 서브 버튼 */
        .join-container button.sub-btn {
            height: 43px;
            background-color: #b07a3a;
            color: #fff9f0;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(176, 122, 58, 0.5);
            transition: background-color 0.3s ease;
        }

        .join-container button.sub-btn:hover {
            background-color: #a06934;
        }

        /* 이미 회원이신가요? 영역 */
        .login-link {
            margin-top: 30px;
            text-align: center;
            font-size: 1rem;
            color: #6f5a3e;
        }

        .login-link a {
            color: #b07a3a;
            text-decoration: none;
            font-weight: 500;
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        .login-link a:hover {
            color: #8c6c4b;
            text-decoration: underline;
        }

        /* 필수 입력 표시 */
        .required-mark, .required-indicator {
            color: #c25e3a;
            margin-left: 4px;
        }

        /* 인라인 에러 메시지 스타일 */
        .error-message {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .input-error {
            border: 1.8px solid #e53e3e !important;
            box-shadow: 0 0 10px rgba(229, 62, 62, 0.3);
        }

        /* disabled 상태일 때의 스타일 */
        .input-group input:disabled {
            background-color: #e0e0e0;
            color: #757575;
            cursor: not-allowed;
            border-color: #bdbdbd;
        }

        /* 도움말 텍스트 스타일 */
        .input-hint {
            font-size: 0.85rem; /* 오류 메시지와 비슷하게 혹은 조금 작게 */
            color: #888; /* 오류 메시지보다 연한 색상 */
            margin-top: 5px; /* 라벨과 입력 필드 사이의 간격을 조절 */
            margin-bottom: 10px; /* 입력 필드와의 간격 조절 */
            line-height: 1.3;
        }

        /* 반응형 */
        @media (max-width: 400px) {
            .join-container {
                margin: 20px 10px;
                padding: 25px 20px 30px;
                box-shadow: none;
            }
            .join-container h2 {
                font-size: 2rem;
            }
            .input-group {
                flex-direction: column;
                gap: 5px;
            }
            .input-group button {
                width: 100%;
                padding: 10px;
            }
            .email-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .email-group input,
            .email-group select {
                width: 100%;
            }
        }
    </style>
</head>
<body onload="loadHeaderFooter()">
    <div id="app">
        <div id="header-container"></div>
        <div id="main-content">
            <div class="join-container">
                <h2>회원가입</h2>
                
                <!-- 아이디 필드 -->
                <label for="userId_input">아이디 <span class="required-mark">*</span></label>
                <p class="input-hint">영문 소문자, 숫자 조합 4~12자리 (특수문자 불가)</p>
                <p v-if="userIdError" class="error-message">{{ userIdError }}</p>
                <div class="input-group">
                    <input type="text" v-model="userId" id="userId_input" :disabled="isUserIdDisabled" required placeholder="아이디 입력" :class="{ 'input-error': userIdError }">
                    <button class="sub-btn" @click="fnCheckId">중복확인</button>
                </div>

                <!-- 비밀번호 필드 -->
                <label for="userPwd_input">비밀번호 <span class="required-mark">*</span></label>
                <p class="input-hint">영문 소문자, 숫자 조합 6자리 이상 (특수문자 불가)</p>
                <p v-if="passwordError" class="error-message">{{ passwordError }}</p>
                <input type="password" v-model="userPwd" id="userPwd_input" required placeholder="비밀번호 입력" @input="validatePassword" :class="{ 'input-error': passwordError }">

                <!-- 비밀번호 확인 필드 -->
                <label for="userPwdConfirm_input">비밀번호 확인 <span class="required-mark">*</span></label>
                <p v-if="confirmPasswordError" class="error-message">{{ confirmPasswordError }}</p>
                <input type="password" v-model="userPwdConfirm" id="userPwdConfirm_input" required placeholder="비밀번호 재입력" @input="validateConfirmPassword" :class="{ 'input-error': confirmPasswordError }">

                <!-- 이름 필드 -->
                <label for="userName_input">이름 <span class="required-mark">*</span></label>
                <p v-if="userNameError" class="error-message">{{ userNameError }}</p>
                <input type="text" id="userName_input" v-model="userName" placeholder="이름 입력" @input="validateUserName" :class="{ 'input-error': userNameError }">

                <!-- 이메일 필드 -->
                <label for="emailId_input">E-MAIL(이메일) <span class="required-mark">*</span></label>
                <p v-if="emailError" class="error-message">{{ emailError }}</p>
                <div class="input-group email-group">
                    <input type="email" id="emailId_input" v-model="emailId" placeholder="이메일 아이디 입력" @input="validateEmail" :class="{ 'input-error': emailError }">
                    <span class="email-at">@</span>
                    <input type="email" v-model="emailDomain" :disabled="selectedDomain !== 'direct'" @input="validateEmail" :class="{ 'input-error': emailError }">
                    <select v-model="selectedDomain" @change="handleDomainChange">
                        <option value="direct">직접 입력</option>
                        <option value="naver.com">naver.com</option>
                        <option value="gmail.com">gmail.com</option>
                        <option value="daum.net">daum.net</option>
                    </select>
                </div>

                <!-- 핸드폰 번호 필드 -->
                <label for="phoneInput">핸드폰 번호 <span class="required-mark">*</span></label>
                <p v-if="phoneError" class="error-message">{{ phoneError }}</p>
                <input type="text" v-model="phone" id="phoneInput" required placeholder="(-) 하이픈 제외 숫자만 입력" @input="validatePhone" :class="{ 'input-error': phoneError }">

                <!-- 주소 필드 -->
                <label for="address">주소</label>
                <div class="input-group">
                    <input type="text" id="address" v-model="address">
                    <button class="sub-btn" @click="fnAddr">주소 검색</button>
                </div>

                <!-- 일반 오류 메시지 -->
                <p v-if="generalError" class="error-message general-error">{{ generalError }}</p>

                <!-- 회원가입 버튼 -->
                <button class="join-btn" @click="fnRegister">회원가입</button>
            </div>
        </div>
        <div id="footer-container"></div>
    </div>
</body>
</html>

<script>
    // 헤더와 푸터를 동적으로 불러오는 함수
    function loadHeaderFooter() {
        // 헤더 로드
        fetch('LIB_Header.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Header.html에서 <header> 태그 부분만 추출하여 삽입
                const headerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('header');
                document.getElementById('header-container').appendChild(headerContent);
            });
        
        // 푸터 로드
        fetch('LIB_Footer.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Footer.html에서 <footer> 태그 부분만 추출하여 삽입
                const footerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('footer');
                document.getElementById('footer-container').appendChild(footerContent);
            });
    }
    function jusoCallBack(roadFullAddr, roadAddrPart1, addrDetail, roadAddrPart2, engAddr, jibunAddr, zipNo, admCd, rnMgtSn, bdMgtSn, detBdNmList, bdNm, bdKdcd, siNm, sggNm, emdNm, liNm, rn, udrtYn, buldMnnm, buldSlno, mtYn, lnbrMnnm, lnbrSlno, emdNo) {
        console.log("roadFullAddr =>", roadFullAddr);
        console.log("roadAddrPart1 =>", roadAddrPart1);
        console.log("addrDetail =>", addrDetail);
        console.log("roadAddrPart2 =>", roadAddrPart2);
        console.log("engAddr =>", engAddr);
        console.log("jibunAddr =>", jibunAddr);
        console.log("zipNo =>", zipNo);
        console.log("admCd =>", admCd);
        console.log("rnMgtSn =>", rnMgtSn);
        console.log("bdMgtSn =>", bdMgtSn);
        console.log("detBdNmList =>", detBdNmList);
        console.log("bdNm =>", bdNm);
        console.log("bdKdcd =>", bdKdcd);
        console.log("siNm =>", siNm);
        console.log("sggNm =>", sggNm);
        console.log("emdNm =>", emdNm);
        console.log("liNm =>", liNm);
        console.log("rn =>", rn);
        console.log("udrtYn =>", udrtYn);
        console.log("buldMnnm =>", buldMnnm);
        console.log("buldSlno =>", buldSlno);
        console.log("mtYn =>", mtYn);
        console.log("lnbrMnnm =>", lnbrMnnm);
        console.log("lnbrSlno =>", lnbrSlno);
        console.log("emdNo =>", emdNo);
        // window.vueObj.fnResult(roadFullAddr, roadAddrPart1, addrDetail, engAddr);
        // 전체 주소를 Vue 인스턴스의 address 변수에 할당
        window.app._instance.data.address = roadFullAddr;
    }
    const app = Vue.createApp({
        data() {
            return {
                userId: "",
                userPwd: "",
                userPwdConfirm: "",
                userName: "",
                emailId: "",
                emailDomain: "",
                selectedDomain: "direct",
                phone: "",
                address: "",
                isUserIdDisabled: false,
                isIdDuplicationChecked: false,
                
                // 오류 메시지 상태 변수들 추가
                userIdError: null,
                passwordError: null,
                confirmPasswordError: null,
                userNameError: null,
                emailError: null,
                phoneError: null,
                generalError: null
            };
        },
        methods: {
            // 함수(메소드) - (key : function())

            // 이메일 도메인 선택 처리 메소드
            handleDomainChange: function() {
                let self = this;
                
                if(self.selectedDomain === 'direct') {
                    // '직접 입력' 선택 시 도메인 입력란 활성화
                    self.emailDomain = '';
                    // Vue에서는 disabled 속성을 데이터로 관리 가능
                } else {
                    // 특정 도메인 선택 시 해당 값 자동 입력
                    self.emailDomain = self.selectedDomain;
                }
                self.validateEmail();
            },
            // 전화번호 형식 변환 함수
            // rawPhoneNumber: 하이픈 제외된 숫자만 있는 문자열
            formatPhoneNumber: function(rawPhoneNumber) {
                if (!rawPhoneNumber) return ""; // 입력값이 없으면 빈 문자열 반환

                // 숫자 외의 모든 문자 제거
                const cleaned = rawPhoneNumber.replace(/[^0-9]/g, '');
                let result = cleaned; // 기본값은 숫자만 있는 상태

                // 한국 휴대폰 번호 (010으로 시작하고 11자리) 형식에 맞춰 변환
                // 예: 01012345678 -> 010-1234-5678
                if (cleaned.length === 11 && cleaned.startsWith('010')) {
                    result = cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
                } 
                // 10자리 번호 (02-xxxx-xxxx 또는 0XX-xxx-xxxx)
                else if (cleaned.length === 10) {
                    if (cleaned.startsWith('02')) { // 서울 번호 (02-xxxx-xxxx)
                        result = cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1-$2-$3');
                    } else { // 일반 지역번호 (0XX-xxx-xxxx)
                        result = cleaned.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                    }
                }

                return result;
            },
            // 오류 메시지 초기화 메소드
            clearErrors() {
                this.userIdError = null;
                this.passwordError = null;
                this.confirmPasswordError = null;
                this.userNameError = null;
                this.emailError = null;
                this.phoneError = null;
                this.generalError = null;
            },
            
            // 유효성 검사 메소드들
            validateUserId() {
                this.userIdError = null;
                if (!this.userId || this.userId.trim() === "") {
                    this.userIdError = "아이디를 입력해주세요.";
                    return false;
                }
                return true;
            },
            
            validatePassword() {
                this.passwordError = null;
                if (!this.userPwd || this.userPwd.trim() === "") {
                    this.passwordError = "비밀번호를 입력해주세요.";
                    return false;
                }
                
                const pwdRule = /^(?=.*[a-z])(?=.*\d)[a-z\d]{6,}$/;
                if (!pwdRule.test(this.userPwd)) {
                    this.passwordError = "비밀번호는 영어 소문자와 숫자를 포함하여 6자리 이상이어야 합니다.";
                    return false;
                }
                return true;
            },
            
            validateConfirmPassword() {
                this.confirmPasswordError = null;
                if (!this.userPwdConfirm || this.userPwdConfirm.trim() === "") {
                    this.confirmPasswordError = "비밀번호 확인을 입력해주세요.";
                    return false;
                }
                
                if (this.userPwd !== this.userPwdConfirm) {
                    this.confirmPasswordError = "비밀번호가 일치하지 않습니다.";
                    return false;
                }
                return true;
            },
            
            validateUserName() {
                this.userNameError = null;
                if (!this.userName || this.userName.trim() === "") {
                    this.userNameError = "이름을 입력해주세요.";
                    return false;
                }
                return true;
            },
            
            validateEmail() {
                this.emailError = null;
                if (!this.emailId || this.emailId.trim() === "" || !this.emailDomain || this.emailDomain.trim() === "") {
                    this.emailError = "이메일을 입력해주세요.";
                    return false;
                }
                
                const email = this.emailId.trim() + "@" + this.emailDomain.trim();
                const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
                if (!emailRegex.test(email)) {
                    this.emailError = "올바른 이메일 형식이 아닙니다.";
                    return false;
                }
                return true;
            },
            
            validatePhone() {
                this.phoneError = null;
                if (!this.phone || this.phone.trim() === "") {
                    this.phoneError = "핸드폰 번호를 입력해주세요.";
                    return false;
                }
                
                const phoneDigitsOnlyRegex = /^[0-9]+$/;
                if (!phoneDigitsOnlyRegex.test(this.phone.trim())) {
                    this.phoneError = "핸드폰 번호는 숫자만 입력해주세요.";
                    return false;
                }
                return true;
            },
            // 아이디 중복 확인 메소드 수정
            fnCheckId() {
                let self = this;
                self.userIdError = null;
                
                // 아이디 입력 여부 확인
                if(!self.userId || self.userId.trim() === "") {
                    self.userIdError = "아이디를 입력해주세요.";
                    document.getElementById("userId_input").focus();
                    return;
                }

                // 아이디 정규식 검사 (영문 소문자, 숫자 조합 4~12자)
                const idRule = /^[a-z0-9]{4,12}$/;
                if(!idRule.test(self.userId)) {
                    self.userIdError = "아이디는 영문 소문자와 숫자 조합으로 4~12자리여야 합니다.";
                    document.getElementById("userId_input").focus();
                    return;
                }
                
                // 서버에 중복 확인 요청
                $.ajax({
                    url: "http://localhost:3009/lib/checkId",
                    dataType: "json",
                    type: "GET",
                    data: { userId: self.userId },
                    success: function(data) {
                        if(data.duplicate) {
                            self.userIdError = "이미 사용 중인 아이디입니다. 다른 아이디를 입력해주세요.";
                            self.isIdDuplicationChecked = false;
                            self.isUserIdDisabled = false;
                            document.getElementById("userId_input").focus();
                        } else {
                            alert("사용 가능한 아이디입니다."); // 긍정적인 메시지는 alert로 유지
                            self.isIdDuplicationChecked = true;
                            self.isUserIdDisabled = true;
                            document.getElementById("userPwd_input").focus();
                        }
                    },
                    error: function() {
                        self.userIdError = "서버 통신 오류가 발생했습니다. 다시 시도해주세요.";
                    }
                });
            },
            
            // 회원가입 처리 메소드 수정
            fnRegister() {
                let self = this;
                // 모든 오류 메시지 초기화
                self.clearErrors();
                
                // 아이디 중복확인 여부 검사
                if (!self.isIdDuplicationChecked) {
                    self.userIdError = "아이디 중복확인을 먼저 해주세요.";
                    document.getElementById("userId_input").focus();
                    return;
                }

                // 각 필드별 유효성 검사 실행
                const isPasswordValid = self.validatePassword();
                const isConfirmPasswordValid = self.validateConfirmPassword();
                const isUserNameValid = self.validateUserName();
                const isEmailValid = self.validateEmail();
                const isPhoneValid = self.validatePhone();
                
                // 하나라도 유효하지 않으면 해당 필드에 포커스
                if (!isPasswordValid) {
                    document.getElementById("userPwd_input").focus();
                    return;
                }
                if (!isConfirmPasswordValid) {
                    document.getElementById("userPwdConfirm_input").focus();
                    return;
                }
                if (!isUserNameValid) {
                    document.getElementById("userName_input").focus();
                    return;
                }
                if (!isEmailValid) {
                    document.getElementById("emailId_input").focus();
                    return;
                }
                if (!isPhoneValid) {
                    document.getElementById("phoneInput").focus();
                    return;
                }
                
                // 이메일 조합
                let email = self.emailId.trim() + "@" + self.emailDomain.trim();
                
                // 서버로 전송할 데이터
                let param = {
                    userId: self.userId.trim(),
                    password: self.userPwd.trim(),
                    name: self.userName.trim(),
                    email: email,
                    phone: self.formatPhoneNumber(self.phone),
                    address: self.address || ''
                };
                
                // 서버에 회원가입 요청
                $.ajax({
                    url: "http://localhost:3009/lib/join",
                    dataType: "json",
                    type: "GET",
                    data: param,
                    success: function(data) {
                        if(data.success) {
                            alert("회원가입이 완료되었습니다. 로그인 페이지로 이동합니다.");
                            location.href = "LIB_Login.html";
                        } else {
                            self.generalError = data.message || "회원가입에 실패했습니다. 다시 시도해주세요.";
                        }
                    },
                    error: function() {
                        self.generalError = "서버 통신 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
                    }
                });
            }
        }, // methods
        mounted() {
            // 처음 시작할 때 실행되는 부분
            let self = this;
        }
    });
    app.mount('#app');
</script>