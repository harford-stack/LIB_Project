<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PageStudy - 좌석 예약</title>
    <link rel="stylesheet" href="LIB_Style_Mobile.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* 전체 예약 페이지 컨테이너 */
        .reservation-container {
            max-width: 1000px;
            width: 100%;
            box-sizing: border-box;
            margin: 0 auto;
            padding: 25px 20px;
            background: #fefcf7;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(176, 122, 58, 0.2);
            font-family: 'Noto Sans KR', sans-serif;
            color: #5a4631;
        }
        .active-reservation-warning {
            text-align: center;
        }

        /* 헤더 */
        .reservation-container h2 {
            margin-bottom: 25px;
            text-align: center;
        }

        .reservation-container h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: #8c6c4b;
            letter-spacing: -0.5px;
            text-align: center;
        }

        .btn-back-to-main {
            background-color: #8c7b64;
            color: #fff9f0;
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(140, 123, 100, 0.4);
            transition: background-color 0.3s ease;
        }

        .btn-back-to-main:hover {
            background-color: #7a6a54;
        }

        /* 섹션 공통 스타일 */
        section {
            background-color: #fff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(176, 122, 58, 0.08);
        }

        /* 섹션 제목 */
        section h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #a06934;
            margin-bottom: 20px;
            text-align: center;
        }

        /* 날짜 선택 input */
        .date-selection input[type="date"] {
            width: 90%;
            padding: 12px 14px;
            font-size: 1.1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .date-selection input[type="date"]:disabled {
            background-color: #f0e9e0;
            color: #8c7b64;
            cursor: not-allowed;
        }

        .date-selection input[type="date"]:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        /* 시간 선택용 container */
        .time-slots {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }

        /* 각 시간 선택 블록 */
        .time-selector {
            flex: 1;
            text-align: center;
        }

        /* 라벨 */
        .time-selector label {
            display: block;
            font-weight: 600;
            color: #6f5a3e;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        /* select */
        .time-selector select {
            width: 100%;
            padding: 12px 10px;
            font-size: 1rem;
            border: 1.8px solid #d9caae;
            border-radius: 12px;
            background-color: #fefcf7;
            color: #5a4631;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .time-selector select:focus {
            border-color: #b07a3a;
            outline: none;
            box-shadow: 0 0 10px rgba(176, 122, 58, 0.4);
        }

        .time-selector select:disabled {
            background-color: #f0e9e0;
            color: #8c7b64;
            cursor: not-allowed;
        }

        /* 좌석 배치 + 정보 컨테이너 */
        .seat-map-container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            flex-direction: column;
            align-items: center;
        }

        /* 좌석 배치도 */
        .seat-layout {
            flex: 2;
            min-width: unset;
            width: 80%;
            max-width: 600px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: auto;
            gap: 10px;
            border: 1px solid #e6d9c4;
            padding: 20px;
            border-radius: 15px;
            background-color: #fcfaf6;
            aspect-ratio: auto; /* 가로세로 비율 */
            position: relative;
        }

        /* 좌석 스타일 */
        .seat {
            background-color: #e6d9c4;
            border: 1px solid #d9caae;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6f5a3e;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .seat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(176, 122, 58, 0.2);
        }

        .seat.available {
            background-color: #bbf0b3;
            border-color: #a0d4a0;
        }

        .seat.occupied {
            background-color: #f0c3bb;
            border-color: #d4a0a0;
            cursor: not-allowed;
        }

        .seat.occupied:hover {
            transform: none;
            box-shadow: none;
        }

        .seat.selected {
            background-color: #ffe0b2;
            border-color: #ffb74d;
            box-shadow: 0 0 0 3px #ffb74d;
        }

        /* 좌석 영역별 grid 배치 */
        /* 일반석 왼쪽 */
        .regular-seats.left {
            grid-area: 1 / 1 / span 4 / span 2;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
        }
        .regular-seats.left .seat { padding: 5px; }

        /* 일반석 아래 */
        .regular-seats.bottom {
            grid-area: 6 / 1 / span 1 / span 2;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
        }
        .regular-seats.bottom .seat { padding: 5px; }

        /* 1인실 */
        .private-rooms {
            grid-area: 6 / 6 / span 1 / span 2;
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
        }
        .private-rooms .seat {
            background-color: #e0f2f7;
            border-color: #a7d9eb;
            font-size: 0.85rem;
        }

        /* 그룹실 */
        .group-rooms {
            grid-area: 1 / 6 / span 3 / span 2;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
        }
        .group-rooms .seat {
            background-color: #e8e2f8;
            border-color: #b7a8da;
        }

        /* 노트북석 */
        .laptop-seats {
            grid-area: 3 / 6 / span 3 / span 2;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 8px;
        }
        .laptop-seats .seat {
            background-color: #ffecc0;
            border-color: #ffd880;
        }

        /* 휴게실 */
        .break-room {
            grid-area: 7 / 1 / span 2 / span 3;
            background-color: #f2e7d7;
            border: 1px dashed #d9c8b3;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: #8c7b64;
            font-size: 1rem;
        }

        /* 출입문 */
        .entrance-door {
            grid-area: 7 / 6 / span 2 / span 2;
            background-color: #f7f2ea;
            border: 1px dashed #d9d0c1;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #a59b8d;
            font-size: 0.95rem;
        }

        /* 좌석 정보 표시 */
        .seat-info {
            flex: 1;
            min-width: unset;
            width: 80%;
            background-color: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(176, 122, 58, 0.08);
            border: 1px solid #e6d9c4;
            display: flex;
            flex-direction: column;
        }

        .seat-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #a06934;
            margin-bottom: 15px;
            border-bottom: 1px solid #e6d9c4;
            padding-bottom: 10px;
        }

        .seat-info p {
            font-size: 1rem;
            color: #6f5a3e;
            margin-bottom: 8px;
        }

        .seat-info p:last-of-type {
            margin-bottom: 20px;
        }

        /* 예약하기 버튼 */
        .booking-actions {
            margin-top: auto;
            text-align: center;
        }

        .booking-actions .btn-reserve.reserve-btn {
            background-color: #b07a3a;
            color: #fff9f0;
            border: none;
            border-radius: 14px;
            padding: 12px 25px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(176, 122, 58, 0.6);
            transition: background-color 0.3s ease;
        }

        .booking-actions .btn-reserve.reserve-btn:hover {
            background-color: #a06934;
        }

        /* 예약 요약 섹션 */
        .reservation-summary-section {
            margin-top: 30px;
            background-color: #f8f4ec;
            border: 1px solid #e6d9c4;
            border-radius: 15px;
            padding: 20px;
        }

        .reservation-summary-section h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #a06934;
            margin-bottom: 15px;
            border-bottom: 1px solid #e6d9c4;
            padding-bottom: 10px;
        }

        .reservation-summary-section p {
            font-size: 1rem;
            color: #6f5a3e;
            margin-bottom: 8px;
            white-space: normal;
        }

        /* 메시지 섹션 */
        .success-message, .error-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body onload="loadHeaderFooter()">
    <main id="app">
        <div id="header-container"></div>
        <div id="main-content">
            <div class="reservation-container">
                <h2>좌석 예약</h2>
                
                <main2>
                    <!-- 날짜 선택 영역 -->
                    <section class="date-selection">
                        <h2>예약 날짜 선택</h2>
                        <input type="date" v-model="selectedDate" :min="today" @change="onDateChange">
                    </section>

                    <!-- 시간 선택 영역 -->
                    <section class="time-selection">
                        <h2>이용 시간 선택</h2>
                        <div class="time-slots">
                            <div class="time-selector">
                                <label for="startTime">시작 시간:</label>
                                <select id="startTime" v-model="startHour">
                                    <option value="">시작 시간 선택</option>
                                    <option v-for="hour in availableHours" :value="hour">{{ hour }}:00</option>
                                </select>
                            </div>
                            <div class="time-selector">
                                <label for="endTime">종료 시간:</label>
                                <select id="endTime" v-model="endHour" :disabled="!startHour">
                                    <option value="">종료 시간 선택</option>
                                    <option v-for="hour in getAvailableEndHours()" :value="hour">{{ hour }}:00</option>
                                </select>
                            </div>
                        </div>
                    </section>

                    <!-- 좌석 맵 영역 -->
                    <section class="seat-map" v-if="startHour && endHour">
                        <h2>좌석 선택<br>(선택된 시간:<br>{{ startHour }}:00 ~ {{ endHour }}:00)</h2>
                        <div class="seat-map-container">
                            <!-- 좌석 배치도 -->
                            <div class="seat-layout">
                                <!-- 일반석 영역 (왼쪽) -->
                                <div class="regular-seats left">
                                    <div v-for="seat in regularSeatsLeft" :key="seat.seatno"
                                        :class="['seat', getSeatStatusClass(seat)]" @click="selectSeat(seat)">
                                        {{ seat.location }}
                                    </div>
                                </div>

                                <!-- 일반석 영역 (아래쪽) -->
                                <div class="regular-seats bottom">
                                    <div v-for="seat in regularSeatsBottom" :key="seat.seatno"
                                        :class="['seat', getSeatStatusClass(seat)]" @click="selectSeat(seat)">
                                        {{ seat.location }}
                                    </div>
                                </div>

                                <!-- 1인실 영역 -->
                                <div class="private-rooms">
                                    <div v-for="seat in privateRooms" :key="seat.seatno"
                                        :class="['seat', 'private-room', getSeatStatusClass(seat)]" @click="selectSeat(seat)">
                                        {{ seat.location }}
                                    </div>
                                </div>

                                <!-- 그룹실 영역 -->
                                <div class="group-rooms">
                                    <div v-for="seat in groupRooms" :key="seat.seatno"
                                        :class="['seat', 'group-room', getSeatStatusClass(seat)]" @click="selectSeat(seat)">
                                        {{ seat.location }} ({{ seat.capacity }}인실)
                                    </div>
                                </div>

                                <!-- 노트북석 영역 -->
                                <div class="laptop-seats">
                                    <div v-for="seat in laptopSeats" :key="seat.seatno"
                                        :class="['seat', 'laptop-seat', getSeatStatusClass(seat)]" @click="selectSeat(seat)">
                                        {{ seat.location }}
                                    </div>
                                </div>

                                <div class="break-room">휴게실</div>
                                <div class="entrance-door">출입문</div>
                            </div>

                            <!-- 좌석 정보 표시 -->
                            <div class="seat-info" v-if="selectedSeat">
                                <h3>{{ selectedSeat.location }} 좌석 정보</h3>
                                <p>{{ selectedSeat.seat_notes }}</p>
                                <p>좌석 유형: {{ getSeatTypeName(selectedSeat.typeno) }}</p>
                                <p>시간당 가격: {{ getSeatTypePrice(selectedSeat.typeno) }}원</p>
                                <p>상태: {{ selectedSeat.seatstatus }}</p>
                            </div>
                        </div>
                    </section>

                    <!-- 예약 요약 및 버튼 (selectedSeat도 선택되어야만 보이도록) -->
                    <section v-if="selectedSeat && selectedSeat.seatstatus === 'AVAILABLE' && startHour && endHour">
                        <div class="reservation-summary">
                            <h3>예약 정보 요약</h3>
                            <p>선택 좌석: {{ selectedSeat.location }}</p>
                            <p>예약 날짜: {{ formatDate(selectedDate) }}</p>
                            <p>이용 시간: {{ startHour }}:00 ~ {{ endHour }}:00 ({{ endHour - startHour }}시간)</p>
                            <p>총 금액: {{ calculateTotalPrice() }}원</p>
                            <button @click="makeReservation" class="btn-reserve reserve-btn">예약하기</button>
                        </div>

                        <div v-if="message" :class="isSuccess ? 'success-message' : 'error-message'">
                            {{ message }}
                        </div>
                    </section>
                </main2>
            </div>
        </div>
        <div id="footer-container"></div>
    </main>
</body>
</html>

<script>
    // 헤더와 푸터를 동적으로 불러오는 함수
    function loadHeaderFooter() {
        // 헤더 로드
        fetch('LIB_Header.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Header.html에서 <header> 태그 부분만 추출하여 삽입
                const headerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('header');
                document.getElementById('header-container').appendChild(headerContent);
            });
        
        // 푸터 로드
        fetch('LIB_Footer.html')
            .then(response => response.text())
            .then(data => {
                // LIB_Footer.html에서 <footer> 태그 부분만 추출하여 삽입
                const footerContent = new DOMParser()
                    .parseFromString(data, 'text/html')
                    .querySelector('footer');
                document.getElementById('footer-container').appendChild(footerContent);
            });
    }
    const app = Vue.createApp({
        data() {
            return {
                // 날짜 관련
                selectedDate: new Date().toISOString().split('T')[0],
                today: new Date().toISOString().split('T')[0],

                // 좌석 관련
                allSeats: [],
                seatTypes: [],
                selectedSeat: null,

                // 시간 관련
                startHour: null,
                endHour: null,

                // 사용자 정보 (로그인 사용자 정보를 세션에서 가져올 예정)
                userId: '',

                // 예약 상태 메시지
                message: '',
                isSuccess: false,

                hasActiveReservation: false,
                activeReservationWarningDisplayed: false
            };
        },
        computed: {
            // 좌석 유형별로 분류
            regularSeatsLeft() {
                return this.allSeats.filter(seat =>
                    seat.typeno === 1 && seat.location.includes('A'));
            },
            regularSeatsBottom() {
                return this.allSeats.filter(seat =>
                    seat.typeno === 1 && seat.location.includes('B'));
            },
            privateRooms() {
                return this.allSeats.filter(seat => seat.typeno === 2);
            },
            groupRooms() {
                return this.allSeats.filter(seat => seat.typeno === 3);
            },
            laptopSeats() {
                return this.allSeats.filter(seat => seat.typeno === 4);
            },
            availableHours() {
                const now = new Date();
                const selectedDate = new Date(this.selectedDate);
                
                // 선택한 날짜가 오늘인지 확인 (연, 월, 일만 비교)
                const isToday = selectedDate.getFullYear() === now.getFullYear() && 
                                selectedDate.getMonth() === now.getMonth() && 
                                selectedDate.getDate() === now.getDate();
                
                // 기본 영업 시간 설정 (9시부터 22시까지)
                const startHour = 9;
                const endHour = 22;
                
                // 시간 배열 생성
                let hours = [];
                
                if (isToday) {
                    // 현재 시간에서 1시간 후부터 예약 가능하도록 설정
                    const currentHour = now.getHours();
                    const minStartHour = Math.max(startHour, currentHour + 1);
                    
                    // 현재 시간 이후부터 영업 종료 시간까지만 표시
                    for (let h = minStartHour; h < endHour; h++) {
                        hours.push(h);
                    }
                } else {
                    // 오늘이 아닌 날짜는 전체 영업 시간 표시
                    for (let h = startHour; h < endHour; h++) {
                        hours.push(h);
                    }
                }
                return hours;
            }
        },
        methods: {
            goToMainPage() {
                location.href = "LIB_Main.html";
            },
            // 좌석 상태에 따른 CSS 클래스 반환
            getSeatStatusClass(seat) {
                if (seat.seatstatus === 'OCCUPIED') return 'occupied';
                if (this.selectedSeat && this.selectedSeat.seatno === seat.seatno) return 'selected';
                return 'available';
            },

            // 좌석 유형 이름 가져오기
            getSeatTypeName(typeNo) {
                const type = this.seatTypes.find(type => type.typeno === typeNo);
                return type ? type.typename : '';
            },

            // 좌석 유형 가격 가져오기
            getSeatTypePrice(typeNo) {
                const type = this.seatTypes.find(type => type.typeno === typeNo);
                return type ? type.price : 0;
            },

            // 좌석 선택
            selectSeat(seat) {
                console.log('좌석 클릭됨:', seat); 
                if (seat.seatstatus === 'OCCUPIED') {
                    alert('이미 예약된 좌석입니다. 다른 시간을 선택하거나 다른 좌석을 선택해주세요.');
                    this.selectedSeat = null; // 선택된 좌석 초기화
                    return;
                }
                this.selectedSeat = seat;
            },
            // 선택한 시작 시간에 따른 가능한 종료 시간 목록 반환
            getAvailableEndHours() {
                if (!this.startHour) return [];
                
                // 영업 종료 시간 (22시)
                const closingHour = 22;
                
                // 시작 시간 이후부터 영업 종료 시간까지의 배열 생성
                const endHours = [];
                for (let h = parseInt(this.startHour) + 1; h <= closingHour; h++) {
                    endHours.push(h);
                }
                
                return endHours;
            },

            // 날짜 포맷팅
            formatDate(dateString) {
                const date = new Date(dateString);
                return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            },
            onDateChange() {
            // 날짜가 변경되면 선택된 시간 초기화
            this.startHour = null;
            this.endHour = null;
            },

            // 총 가격 계산
            calculateTotalPrice() {
                if (!this.startHour || !this.endHour || !this.selectedSeat) return 0;

                const hours = this.endHour - this.startHour;
                const hourlyPrice = this.getSeatTypePrice(this.selectedSeat.typeno);
                return hours * hourlyPrice;
            },

            // 예약하기
            makeReservation() {
                if (this.hasActiveReservation) {
                    this.showActiveReservationWarning(); // 경고창을 다시 보여줌
                    return;
                }
                let self = this;
                // 이 부분은 이미 mounted에서 체크했지만, 버튼 클릭 시점에도 다시 한번 확인
                if (!self.userId) {
                    alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.'); 
                    location.href = "LIB_Login.html"; 
                    return;
                }
                if (!self.selectedSeat || !self.startHour || !self.endHour) {
                    alert('좌석, 시작 시간, 종료 시간을 모두 선택해주세요.');
                    return;
                }
                // 예약 정보 객체 생성
                const reservationData = {
                    userId: this.userId,
                    seatNo: this.selectedSeat.seatno,
                    resvDate: this.selectedDate,
                    startHour: this.startHour,
                    endHour: this.endHour,
                    totalPrice: this.calculateTotalPrice()
                };

                // AJAX를 통한 예약 처리
                $.ajax({
                    url: "http://localhost:3009/reservation",
                    dataType: "json",
                    type: "GET",
                    data: reservationData,
                    success: function (data) {
                        if (data.success) {
                            self.message = '예약이 성공적으로 완료되었습니다! 메인 페이지로 이동합니다.';
                            self.isSuccess = true;
                            alert(self.message);
                            location.href = "LIB_Main.html";
                            
                            // 예약 후 좌석 정보를 다시 불러와서 예약된 상태를 반영
                            self.loadSeats();
                            // 예약 정보 초기화
                            self.selectedSeat = null;
                            self.startHour = null; // 시간 선택 초기화
                            self.endHour = null;   // 시간 선택 초기화
                        } else {
                            self.message = '예약 처리 중 오류가 발생했습니다: ' + data.message;
                            self.isSuccess = false;
                            alert(self.message); 
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error:', error);
                        self.message = '예약 처리 중 서버 통신 오류가 발생했습니다.';
                        self.isSuccess = false;
                        alert(self.message); 
                    }
                });
            },

            // 좌석 정보 불러오기
            loadSeats() {
                let self = this;
                // 날짜, 시작 시간, 종료 시간 모두 선택되어야만 좌석 정보 요청
                if (!self.selectedDate || !self.startHour || !self.endHour) {
                    self.allSeats = []; // 시간 미선택 시 좌석 비우기
                    self.selectedSeat = null;
                    return;
                }

                $.ajax({
                    url: "http://localhost:3009/seats",
                    dataType: "json",
                    type: "GET",
                    data: { 
                        date: self.selectedDate,
                        startHour: self.startHour,
                        endHour: self.endHour
                    },
                    success: function (data) {
                        // 배열 데이터를 객체로 변환 (서버에서 이미 객체 형태로 줄 경우 이 부분 수정 필요)
                        self.allSeats = data.map(seat => ({
                            seatno: seat[0],
                            typeno: seat[1],
                            capacity: seat[2],
                            seatstatus: seat[3], // 서버에서 계산된 상태를 그대로 사용
                            location: seat[4],
                            seat_notes: seat[5]
                        }));
                        console.log('변환된 좌석 데이터:', self.allSeats); 
                        self.selectedSeat = null; // 좌석 새로고침 시 선택 초기화
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching seats:', error);
                        alert('좌석 정보를 불러오는데 실패했습니다.');
                        self.allSeats = []; // 오류 발생 시 좌석 비우기
                    }
                });
            },

            // 좌석 유형 정보 불러오기
            loadSeatTypes() {
                let self = this;
                $.ajax({
                    url: "http://localhost:3009/seattypes",
                    dataType: "json",
                    type: "GET",
                    success: function (data) {
                        self.seatTypes = data.map(type => ({
                            typeno: type[0],
                            typename: type[1],
                            price: type[2],
                            description: type[3]
                        }));
                        console.log('변환된 좌석 유형 데이터:', self.seatTypes); 
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching seat types:', error);
                        alert('좌석 유형 정보를 불러오는데 실패했습니다.');
                    }
                });
            },
            // Mounted에서 로그인 여부 확인
            checkLoginStatus() {
                this.userId = sessionStorage.getItem("sessionId") || '';
                if (!this.userId) {
                    alert('서비스 이용을 위해 로그인이 필요합니다. 로그인 페이지로 이동합니다.');
                    location.href = "LIB_Login.html"; // 로그인 페이지로 이동
                    return;
                }
            },
            // 1인 1예약 체크 메소드
            async checkActiveReservations() { // async 키워드를 붙여 비동기 처리
                let self = this;
                console.log('checkActiveReservations 함수 실행됨');
                console.log('현재 userId:', self.userId);
                try {
                    console.log('AJAX 요청 시작, 파라미터:', { userId: self.userId });
                    const response = await $.ajax({
                        url: "http://localhost:3009/user/active-reservations",
                        dataType: "json",
                        type: "GET",
                        data: { userId: self.userId }
                    });
                    
                    console.log('서버 응답 데이터:', response);
                    if (response.success && response.hasActiveReservation) {
                        console.log('활성 예약 있음:', response.activeCount);
                        // 활성 예약이 있으면 예약 UI 비활성화 및 경고 메시지 표시
                        self.hasActiveReservation = true;
                        if (!self.activeReservationWarningDisplayed) { // 한 번만 표시되도록
                            self.showActiveReservationWarning();
                            self.activeReservationWarningDisplayed = true;
                        }
                    } else {
                        console.log('활성 예약 없음');
                        // 활성 예약이 없으면 정상적으로 예약 UI 활성화
                        self.hasActiveReservation = false;
                        self.activeReservationWarningDisplayed = false;
                        // 활성화 로직이 필요한 경우 (예: 이전에 비활성화된 경우) 여기에 추가
                        this.enableReservationUI(); 
                    }
                } catch (err) {
                    console.error('활성 예약 확인 오류 상세 정보:', err);
                    console.log('에러 객체 타입:', typeof err);
                    console.log('에러 메시지:', err.message);
                    console.log('에러 상태:', err.status);
                    console.error('Error checking active reservations:', err);
                    // 오류 발생 시에도 UI는 활성화 상태로 유지 (사용자에게 불편 주지 않기 위해)
                    self.hasActiveReservation = false;
                    self.activeReservationWarningDisplayed = false;
                    alert('예약 상태 확인 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
                }
            },
            
            // 활성 예약 경고 메시지 표시 및 UI 비활성화
            showActiveReservationWarning() {
                // 경고 div가 이미 있는지 확인하여 중복 생성 방지
                let warningDiv = document.querySelector('.active-reservation-warning');
                if (!warningDiv) {
                    warningDiv = document.createElement('div');
                    warningDiv.className = 'active-reservation-warning';
                    // 메인 컨텐츠 영역 앞에 삽입 (원하는 위치에 따라 변경 가능)
                    const mainContent = document.querySelector('main2');
                    if (mainContent) {
                        mainContent.insertBefore(warningDiv, mainContent.firstChild); // 메인 콘텐츠 최상단에 추가
                    }
                }
                warningDiv.innerHTML = `
                    <h3>⚠️ 이미 완료된 예약이 있습니다</h3>
                    <p><strong>1인 1예약 원칙</strong>을 적용하고 있습니다.</p>
                    <p>새로운 좌석 예약이 불가합니다.<br>예약 내역을 확인해주세요.</p>
                    <button class="btn-view-reservations" onclick="location.href='LIB_MyReservations.html'">내 예약 확인하기</button>
                `;
                
                // 예약 관련 UI 비활성화
                this.disableReservationUI();
            },
            
            // 예약 UI 비활성화
            disableReservationUI() {
                // 날짜 선택 비활성화
                const dateInput = document.querySelector('input[type="date"]');
                if (dateInput) dateInput.disabled = true;
                
                // 시작 시간 선택 비활성화
                const startTimeSelect = document.querySelector('#startTime');
                if (startTimeSelect) startTimeSelect.disabled = true;
                
                // 종료 시간 선택 비활성화
                const endTimeSelect = document.querySelector('#endTime');
                if (endTimeSelect) endTimeSelect.disabled = true;

                // 좌석 비활성화
                document.querySelectorAll('.seat-map-container .seat').forEach(el => {
                    el.classList.add('disabled');
                    el.style.pointerEvents = 'none'; // 클릭 방지 추가
                    el.onclick = null; // 클릭 이벤트 제거
                });
                
                // 예약하기 버튼 비활성화
                const reserveBtn = document.querySelector('.btn-reserve');
                if (reserveBtn) {
                    reserveBtn.disabled = true;
                    reserveBtn.classList.add('disabled');
                }
            },

            // 예약 UI 활성화 (선택 사항 - 나중에 재활성화가 필요할 경우)
            enableReservationUI() {
                // null 체크 추가
                const dateInput = document.querySelector('input[type="date"]');
                if (dateInput) dateInput.disabled = false;
                
                const startHourSelect = document.querySelector('select[v-model="startHour"]');
                if (startHourSelect) startHourSelect.disabled = false;
                
                const endHourSelect = document.querySelector('select[v-model="endHour"]');
                if (endHourSelect) endHourSelect.disabled = false;

                // 나머지 코드도 동일하게 null 체크 추가
                document.querySelectorAll('.seat-map-container .seat.disabled').forEach(el => {
                    el.classList.remove('disabled');
                });
                
                const reserveBtn = document.querySelector('.btn-reserve.disabled');
                if (reserveBtn) {
                    reserveBtn.disabled = false;
                    reserveBtn.classList.remove('disabled');
                }
                
                const warningDiv = document.querySelector('.active-reservation-warning');
                if (warningDiv) {
                    warningDiv.remove();
                }
            }
        },
        watch: {
            // 날짜가 변경되면 시간 초기화 및 좌석 다시 불러오기 시도
            selectedDate(newValue, oldValue) {
                this.startHour = null;
                this.endHour = null;
            },
            // 시작 시간 또는 종료 시간이 변경되면 좌석 정보 다시 불러오기
            startHour(newValue, oldValue) {
                // 시작 시간이 변경되면 종료 시간도 초기화 (시작 시간이 달라졌으니 종료 시간도 다시 선택해야 함)
                if (newValue) { // null이 아닌 유효한 값일 때만
                    this.endHour = null;
                }
                this.loadSeats();
            },
            endHour(newValue, oldValue) {
                this.loadSeats();
            }
        },
        mounted() {
            // 1. 기존 로그인 상태 확인 로직 유지
            this.checkLoginStatus();

            // 3. 현재 날짜 설정 및 좌석 타입 로드 (기존 로직 유지)
            this.today = new Date().toISOString().split('T')[0];
            if (!this.selectedDate) { // selectedDate가 아직 설정되지 않았다면 오늘 날짜로
                this.selectedDate = this.today;
            }
            this.loadSeatTypes();
            
            // 4. 활성 예약 체크 로직 추가
            this.checkActiveReservations();
        }
    });

    app.mount('#app');
</script>